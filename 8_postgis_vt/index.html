



<!DOCTYPE html>
<html lang="es" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copiar al portapapeles">
      
        <meta name="lang:clipboard.copied" content="Copiado al portapapeles">
      
        <meta name="lang:search.language" content="es">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No se encontraron documentos">
      
        <meta name="lang:search.result.one" content="1 documento encontrado">
      
        <meta name="lang:search.result.other" content="# documentos encontrados">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.0.4">
    
    
      
        <title>8. Cómo servir datos desde PostGIS - Trabajando con VT</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.451f80e5.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="../#como-servir-datos-desde-postgis" tabindex="1" class="md-skip">
        Saltar a contenido
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Trabajando con VT" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                Trabajando con VT
              </span>
              <span class="md-header-nav__topic">
                8. Cómo servir datos desde PostGIS
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Búsqueda" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Teclee para comenzar búsqueda
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/geoinquiets/taller-vt/" title="Ir al repositorio" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="Trabajando con VT" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Trabajando con VT
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/geoinquiets/taller-vt/" title="Ir al repositorio" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../1_teoria/" title="1. Qué son" class="md-nav__link">
      1. Qué son
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../2_visor_simple/" title="2. Cómo visualizarlas" class="md-nav__link">
      2. Cómo visualizarlas
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../3_tileserver_gl/" title="3. Cómo servirlas" class="md-nav__link">
      3. Cómo servirlas
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../4_tippecanoe/" title="4. Cómo crearlas" class="md-nav__link">
      4. Cómo crearlas
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../5_sprites_glyphs/" title="5. Sprites y Glyphs" class="md-nav__link">
      5. Sprites y Glyphs
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../6_estilos/" title="6. Cómo simbolizarlas" class="md-nav__link">
      6. Cómo simbolizarlas
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../7_servidor_dinamico/" title="7. Cómo servir datos dinámicos" class="md-nav__link">
      7. Cómo servir datos dinámicos
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        8. Cómo servir datos desde PostGIS
      </label>
    
    <a href="./" title="8. Cómo servir datos desde PostGIS" class="md-nav__link md-nav__link--active">
      8. Cómo servir datos desde PostGIS
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Tabla de contenidos</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#funcion-st_asmvtgeom" title="Función ST_AsMVTGeom" class="md-nav__link">
    Función ST_AsMVTGeom
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#funcion-st_asmvt" title="Función ST_AsMVT" class="md-nav__link">
    Función ST_AsMVT
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#funcion-bbox" title="Función BBox" class="md-nav__link">
    Función BBox
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#crear-la-base-de-datos" title="Crear la base de datos" class="md-nav__link">
    Crear la base de datos
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#combinar-varias-capas-en-una-misma-tesela" title="Combinar varias capas en una misma tesela" class="md-nav__link">
    Combinar varias capas en una misma tesela
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configurar-un-servidor-web-para-que-sirva-las-capas-de-postgis" title="Configurar un servidor web para que sirva las capas de postgis" class="md-nav__link">
    Configurar un servidor web para que sirva las capas de postgis
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ejercicio" title="Ejercicio" class="md-nav__link">
    Ejercicio
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../9_geoserver_vts/" title="9. Servir vector tiles desde GeoServer" class="md-nav__link">
      9. Servir vector tiles desde GeoServer
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Tabla de contenidos</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#funcion-st_asmvtgeom" title="Función ST_AsMVTGeom" class="md-nav__link">
    Función ST_AsMVTGeom
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#funcion-st_asmvt" title="Función ST_AsMVT" class="md-nav__link">
    Función ST_AsMVT
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#funcion-bbox" title="Función BBox" class="md-nav__link">
    Función BBox
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#crear-la-base-de-datos" title="Crear la base de datos" class="md-nav__link">
    Crear la base de datos
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#combinar-varias-capas-en-una-misma-tesela" title="Combinar varias capas en una misma tesela" class="md-nav__link">
    Combinar varias capas en una misma tesela
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configurar-un-servidor-web-para-que-sirva-las-capas-de-postgis" title="Configurar un servidor web para que sirva las capas de postgis" class="md-nav__link">
    Configurar un servidor web para que sirva las capas de postgis
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ejercicio" title="Ejercicio" class="md-nav__link">
    Ejercicio
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/geoinquiets/taller-vt/edit/master/docs/8_postgis_vt.md" title="Editar esta página" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="como-servir-datos-desde-postgis">Cómo servir datos desde PostGIS</h1>
<p>A partir de la versión 2.4.0 de PostGIS están disponibles dos nuevas funciones <a href="https://postgis.net/docs/ST_AsMVTGeom.html"><code>ST_AsMVTGeom</code></a> y <a href="https://postgis.net/docs/ST_AsMVT.html"><code>ST_AsMVT</code></a></p>
<h2 id="funcion-st_asmvtgeom">Función ST_AsMVTGeom</h2>
<p>La función ST_AsMVTGeom transforma una geometría al espacio de coordenadas de una tesela vectorial. Transforma las coordenadas de una geometría en coordenadas dentro de una tesela.</p>
<p>Ejemplo para la capa barrios y la tesela 14/8289/6119 z=14 x=8289 y=6119
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">gid</span><span class="p">,</span> <span class="n">c_distri</span><span class="p">,</span> <span class="n">n_distri</span><span class="p">,</span> <span class="n">c_barri</span><span class="p">,</span> <span class="n">n_barri</span><span class="p">,</span> <span class="n">homes</span><span class="p">,</span> <span class="n">dones</span><span class="p">,</span> <span class="n">area</span><span class="p">,</span> 
  <span class="n">ST_AsMvtGeom</span><span class="p">(</span>
      <span class="n">geom</span><span class="p">,</span>
      <span class="n">BBox</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8289</span><span class="p">,</span> <span class="mi">6119</span><span class="p">),</span>
      <span class="mi">4096</span><span class="p">,</span>
      <span class="mi">256</span><span class="p">,</span>
      <span class="k">true</span>
  <span class="p">)</span> <span class="k">AS</span> <span class="n">geom</span>
<span class="k">FROM</span> <span class="k">public</span><span class="p">.</span><span class="n">barrios</span>
<span class="k">WHERE</span> <span class="n">geom</span> <span class="o">&amp;&amp;</span> <span class="n">BBox</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8289</span><span class="p">,</span> <span class="mi">6119</span><span class="p">)</span>
<span class="k">AND</span> <span class="n">ST_Intersects</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">BBox</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8289</span><span class="p">,</span> <span class="mi">6119</span><span class="p">));</span>
</pre></div>
</td></tr></table></p>
<h2 id="funcion-st_asmvt">Función ST_AsMVT</h2>
<p>La función ST_AsMVT codifica una geometría en coordenadas de teselas como una capa (Layer) <strong>mvt</strong> (pbf)</p>
<p>Ejemplo para la capa barrios y la tesela 14/8289/6119
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">ST_AsMVT</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="s1">&#39;barrios&#39;</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="s1">&#39;geom&#39;</span><span class="p">)</span>
<span class="k">FROM</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="n">gid</span><span class="p">,</span> <span class="n">c_distri</span><span class="p">,</span> <span class="n">n_distri</span><span class="p">,</span> <span class="n">c_barri</span><span class="p">,</span> <span class="n">n_barri</span><span class="p">,</span> <span class="n">homes</span><span class="p">,</span> <span class="n">dones</span><span class="p">,</span> <span class="n">area</span><span class="p">,</span> 
    <span class="n">ST_AsMvtGeom</span><span class="p">(</span>
      <span class="n">geom</span><span class="p">,</span>
      <span class="n">BBox</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8289</span><span class="p">,</span> <span class="mi">6119</span><span class="p">),</span>
      <span class="mi">4096</span><span class="p">,</span>
      <span class="mi">256</span><span class="p">,</span>
      <span class="k">true</span>
    <span class="p">)</span> <span class="k">AS</span> <span class="n">geom</span>
  <span class="k">FROM</span> <span class="k">public</span><span class="p">.</span><span class="n">barrios</span>
  <span class="k">WHERE</span> <span class="n">geom</span> <span class="o">&amp;&amp;</span> <span class="n">BBox</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8289</span><span class="p">,</span> <span class="mi">6119</span><span class="p">)</span>
  <span class="k">AND</span> <span class="n">ST_Intersects</span><span class="p">(</span><span class="n">geom</span><span class="p">,</span> <span class="n">BBox</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8289</span><span class="p">,</span> <span class="mi">6119</span><span class="p">))</span>
<span class="p">)</span> <span class="k">AS</span> <span class="n">q</span><span class="p">;</span>
</pre></div>
</td></tr></table></p>
<p>Como un <strong>mvt</strong> es una succesion de capas, para crear un vector tile multicapa se pueden concatenar varias consultas.</p>
<h2 id="funcion-bbox">Función BBox</h2>
<p>Función que convierte las coordenadas de una tesela (z,x,y) en su correspondiente caja de coordenadas (bbox) en webmercator (EPSG:3857) </p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">CREATE</span> <span class="k">OR</span> <span class="k">REPLACE</span> <span class="k">FUNCTION</span> <span class="n">BBox</span><span class="p">(</span><span class="n">zoom</span> <span class="nb">integer</span><span class="p">,</span> <span class="n">x</span> <span class="nb">integer</span><span class="p">,</span> <span class="n">y</span> <span class="nb">integer</span><span class="p">)</span>
    <span class="k">RETURNS</span> <span class="n">geometry</span> <span class="k">AS</span>
<span class="err">$</span><span class="n">BODY$</span>
<span class="k">DECLARE</span>
    <span class="k">max</span> <span class="nb">numeric</span> <span class="p">:</span><span class="o">=</span> <span class="mi">6378137</span> <span class="o">*</span> <span class="n">pi</span><span class="p">();</span> <span class="c1">--20037508.34;</span>
    <span class="n">res</span> <span class="nb">numeric</span> <span class="p">:</span><span class="o">=</span> <span class="k">max</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">2</span><span class="o">^</span><span class="n">zoom</span><span class="p">;</span>
    <span class="n">bbox</span> <span class="n">geometry</span><span class="p">;</span>
<span class="k">BEGIN</span>
    <span class="k">return</span> <span class="n">ST_MakeEnvelope</span><span class="p">(</span>
        <span class="o">-</span><span class="k">max</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">res</span><span class="p">),</span>
        <span class="k">max</span> <span class="o">-</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">res</span><span class="p">),</span>
        <span class="o">-</span><span class="k">max</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">res</span><span class="p">)</span> <span class="o">+</span> <span class="n">res</span><span class="p">,</span>
        <span class="k">max</span> <span class="o">-</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">res</span><span class="p">)</span> <span class="o">-</span> <span class="n">res</span><span class="p">,</span>
        <span class="mi">3857</span><span class="p">);</span>
<span class="k">END</span><span class="p">;</span>
<span class="err">$</span><span class="n">BODY$</span>
  <span class="k">LANGUAGE</span> <span class="n">plpgsql</span> <span class="k">IMMUTABLE</span><span class="p">;</span>
</pre></div>
</td></tr></table>

<p>En nuestro caso utilizaremos una función un poco más generalista que permite indicar el srid
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">CREATE</span> <span class="k">OR</span> <span class="k">REPLACE</span> <span class="k">FUNCTION</span> <span class="k">public</span><span class="p">.</span><span class="n">tilebbox</span><span class="p">(</span>
    <span class="n">z</span> <span class="nb">integer</span><span class="p">,</span>
    <span class="n">x</span> <span class="nb">integer</span><span class="p">,</span>
    <span class="n">y</span> <span class="nb">integer</span><span class="p">,</span>
    <span class="n">srid</span> <span class="nb">integer</span> <span class="k">DEFAULT</span> <span class="mi">3857</span><span class="p">)</span>
    <span class="k">RETURNS</span> <span class="n">geometry</span>
    <span class="k">LANGUAGE</span> <span class="s1">&#39;plpgsql&#39;</span>

    <span class="n">COST</span> <span class="mi">100</span>
    <span class="k">IMMUTABLE</span> 
<span class="k">AS</span> <span class="err">$</span><span class="n">BODY$</span>
<span class="k">declare</span>
    <span class="k">max</span> <span class="nb">numeric</span> <span class="p">:</span><span class="o">=</span> <span class="mi">20037508</span><span class="p">.</span><span class="mi">34</span><span class="p">;</span> <span class="c1">--6378137 * pi();</span>
    <span class="n">res</span> <span class="nb">numeric</span> <span class="p">:</span><span class="o">=</span> <span class="p">(</span><span class="k">max</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">^</span><span class="n">z</span><span class="p">);</span>
    <span class="n">bbox</span> <span class="n">geometry</span><span class="p">;</span>
<span class="k">begin</span>
    <span class="n">bbox</span> <span class="p">:</span><span class="o">=</span> <span class="n">ST_MakeEnvelope</span><span class="p">(</span>
        <span class="o">-</span><span class="k">max</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">res</span><span class="p">),</span>
        <span class="k">max</span> <span class="o">-</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">res</span><span class="p">),</span>
        <span class="o">-</span><span class="k">max</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">res</span><span class="p">)</span> <span class="o">+</span> <span class="n">res</span><span class="p">,</span>
        <span class="k">max</span> <span class="o">-</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">res</span><span class="p">)</span> <span class="o">-</span> <span class="n">res</span><span class="p">,</span>
        <span class="mi">3857</span>
    <span class="p">);</span>
    <span class="k">if</span> <span class="n">srid</span> <span class="o">=</span> <span class="mi">3857</span> <span class="k">then</span>
        <span class="k">return</span> <span class="n">bbox</span><span class="p">;</span>
    <span class="k">else</span>
        <span class="k">return</span> <span class="n">ST_Transform</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="n">srid</span><span class="p">);</span>
    <span class="k">end</span> <span class="k">if</span><span class="p">;</span>
<span class="k">end</span><span class="p">;</span>
<span class="err">$</span><span class="n">BODY$</span><span class="p">;</span>

<span class="k">ALTER</span> <span class="k">FUNCTION</span> <span class="k">public</span><span class="p">.</span><span class="n">tilebbox</span><span class="p">(</span><span class="nb">integer</span><span class="p">,</span> <span class="nb">integer</span><span class="p">,</span> <span class="nb">integer</span><span class="p">,</span> <span class="nb">integer</span><span class="p">)</span>
    <span class="k">OWNER</span> <span class="k">TO</span> <span class="n">postgres</span><span class="p">;</span>
</pre></div>
</td></tr></table></p>
<h2 id="crear-la-base-de-datos">Crear la base de datos</h2>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Si ya hemos creado la base de datos en el apartado anterior ignorar esta parte</p>
</div>
<p>Descargamos el archivo que contiene el script de creacion de la base de datos y las tablas correspondientes</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>wget https://raw.githubusercontent.com/geoinquiets/taller-vt/master/resultado/datos/bcn_geodata.sql
</pre></div>
</td></tr></table>

<p>Modificamos el archivo bcn_geodata.sql y remplazamos donde dice <em>owner "user"</em> por <em>owner "postgres"</em>. Una vez modificado el archivo cargamos el script con psql</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>psql -U postgres -h localhost &lt; bcn_geodata.sql
</pre></div>
</td></tr></table>

<h2 id="combinar-varias-capas-en-una-misma-tesela">Combinar varias capas en una misma tesela</h2>
<p>Como comentamos anteriormente <em>"un <strong>mvt</strong> es una succesion de capas, para crear un vector tile multicapa se pueden concatenar varias consultas"</em>.</p>
<p>Para combinar varias capas en una misma tesela podemos utilizar una serie de funciones desarrolladas por el ICGC <a href="https://github.com/gencat/ICGC-vt-postgis">https://github.com/gencat/ICGC-vt-postgis</a> que facilitan este trabajo.</p>
<p>Descargar el archivo que permite crear las funciones y el esquema</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>wget https://raw.githubusercontent.com/gencat/ICGC-vt-postgis/master/icgc-vt-postgis-create.sql
</pre></div>
</td></tr></table>

<p>Crear el esquema y las funciones en la base de datos de bcn_geodata</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>psql -U postgres -d bcn_geodata -h localhost -f icgc-vt-postgis-create.sql
</pre></div>
</td></tr></table>

<p>Agregar la funcion tilebbox en nuestra base de datos y agregar las capas en la tabla icgc_vt.layers</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">CREATE</span> <span class="k">OR</span> <span class="k">REPLACE</span> <span class="k">FUNCTION</span> <span class="k">public</span><span class="p">.</span><span class="n">tilebbox</span><span class="p">(</span>
    <span class="n">z</span> <span class="nb">integer</span><span class="p">,</span>
    <span class="n">x</span> <span class="nb">integer</span><span class="p">,</span>
    <span class="n">y</span> <span class="nb">integer</span><span class="p">,</span>
    <span class="n">srid</span> <span class="nb">integer</span> <span class="k">DEFAULT</span> <span class="mi">3857</span><span class="p">)</span>
    <span class="k">RETURNS</span> <span class="n">geometry</span>
    <span class="k">LANGUAGE</span> <span class="s1">&#39;plpgsql&#39;</span>

    <span class="n">COST</span> <span class="mi">100</span>
    <span class="k">IMMUTABLE</span> 
<span class="k">AS</span> <span class="err">$</span><span class="n">BODY$</span>
<span class="k">declare</span>
    <span class="k">max</span> <span class="nb">numeric</span> <span class="p">:</span><span class="o">=</span> <span class="mi">20037508</span><span class="p">.</span><span class="mi">34</span><span class="p">;</span> <span class="c1">--6378137 * pi();</span>
    <span class="n">res</span> <span class="nb">numeric</span> <span class="p">:</span><span class="o">=</span> <span class="p">(</span><span class="k">max</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">^</span><span class="n">z</span><span class="p">);</span>
    <span class="n">bbox</span> <span class="n">geometry</span><span class="p">;</span>
<span class="k">begin</span>
    <span class="n">bbox</span> <span class="p">:</span><span class="o">=</span> <span class="n">ST_MakeEnvelope</span><span class="p">(</span>
        <span class="o">-</span><span class="k">max</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">res</span><span class="p">),</span>
        <span class="k">max</span> <span class="o">-</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">res</span><span class="p">),</span>
        <span class="o">-</span><span class="k">max</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">res</span><span class="p">)</span> <span class="o">+</span> <span class="n">res</span><span class="p">,</span>
        <span class="k">max</span> <span class="o">-</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">res</span><span class="p">)</span> <span class="o">-</span> <span class="n">res</span><span class="p">,</span>
        <span class="mi">3857</span>
    <span class="p">);</span>
    <span class="k">if</span> <span class="n">srid</span> <span class="o">=</span> <span class="mi">3857</span> <span class="k">then</span>
        <span class="k">return</span> <span class="n">bbox</span><span class="p">;</span>
    <span class="k">else</span>
        <span class="k">return</span> <span class="n">ST_Transform</span><span class="p">(</span><span class="n">bbox</span><span class="p">,</span> <span class="n">srid</span><span class="p">);</span>
    <span class="k">end</span> <span class="k">if</span><span class="p">;</span>
<span class="k">end</span><span class="p">;</span>
<span class="err">$</span><span class="n">BODY$</span><span class="p">;</span>

<span class="k">ALTER</span> <span class="k">FUNCTION</span> <span class="k">public</span><span class="p">.</span><span class="n">tilebbox</span><span class="p">(</span><span class="nb">integer</span><span class="p">,</span> <span class="nb">integer</span><span class="p">,</span> <span class="nb">integer</span><span class="p">,</span> <span class="nb">integer</span><span class="p">)</span>
    <span class="k">OWNER</span> <span class="k">TO</span> <span class="n">postgres</span><span class="p">;</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">icgc_vt</span><span class="p">.</span><span class="n">layers</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">geometry_type</span><span class="p">,</span> <span class="n">minz</span><span class="p">,</span> <span class="n">maxz</span><span class="p">,</span> <span class="k">sql</span><span class="p">)</span>
    <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;barrios&#39;</span><span class="p">,</span> <span class="s1">&#39;POLYGON&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="s1">&#39;SELECT ST_AsBinary(geom) AS geom, gid, c_distri, n_distri, c_barri, n_barri, homes, dones, area FROM public.barrios WHERE geom &amp;&amp; !BBOX!&#39;</span><span class="p">);</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">icgc_vt</span><span class="p">.</span><span class="n">layers</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">geometry_type</span><span class="p">,</span> <span class="n">minz</span><span class="p">,</span> <span class="n">maxz</span><span class="p">,</span> <span class="k">sql</span><span class="p">)</span>
    <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;distritos&#39;</span><span class="p">,</span> <span class="s1">&#39;POLYGON&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="s1">&#39;SELECT ST_AsBinary(geom) AS geom, gid, c_distri, n_distri, homes, dones, area FROM public.distritos WHERE geom &amp;&amp; !BBOX!&#39;</span><span class="p">);</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">icgc_vt</span><span class="p">.</span><span class="n">layers</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">geometry_type</span><span class="p">,</span> <span class="n">minz</span><span class="p">,</span> <span class="n">maxz</span><span class="p">,</span> <span class="k">sql</span><span class="p">)</span>
    <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;seccion_censal&#39;</span><span class="p">,</span> <span class="s1">&#39;POLYGON&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="s1">&#39;SELECT ST_AsBinary(geom) AS geom, gid, c_distri, n_distri, c_barri, n_barri, c_aeb, c_seccens, homes, dones, area FROM public.seccion_censal WHERE geom &amp;&amp; !BBOX!&#39;</span><span class="p">);</span>
</pre></div>
</td></tr></table>

<p>Podemos comprobar que la funcion que retorna todas las capas como una tesela funciona</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="n">icgc_vt</span><span class="p">.</span><span class="n">tile_pbf</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">16578</span><span class="p">,</span><span class="mi">12236</span><span class="p">);</span>
</pre></div>
</td></tr></table>

<h2 id="configurar-un-servidor-web-para-que-sirva-las-capas-de-postgis">Configurar un servidor web para que sirva las capas de postgis</h2>
<p>Crearemos un servidor web utilizando el express server que nos permita servir los datos de la base de datos como un Vector Tiles. Para ello utilizaremos una aplicación desarrollada por el ICGC <a href="https://github.com/gencat/ICGC-vtServer">https://github.com/gencat/ICGC-vtServer</a></p>
<p>Clonamos el repositorio</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>git clone https://github.com/gencat/ICGC-vtServer.git

<span class="nb">cd</span> ICGC-vtServer
</pre></div>
</td></tr></table>

<p>Creamos el archivo .env que permitira la conexion a nuestra base de datos con el siguiente contenido</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>DB_USER=postgres
DB_HOST=localhost
DB_DATABASE=bcn_geodata
DB_PASS=postgres
DB_PORT=5432
</pre></div>
</td></tr></table>

<p>Creamos un nuevo archivo el la carpeta de static con el nombre de bcn_geodata.json con el siguiente contenido</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;ICGC&quot;</span><span class="p">,</span>
  <span class="nt">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{},</span>
  <span class="nt">&quot;center&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="mf">1.537786</span><span class="p">,</span>
    <span class="mf">41.837539</span>
  <span class="p">],</span>
  <span class="nt">&quot;zoom&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
  <span class="nt">&quot;bearing&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="nt">&quot;pitch&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="nt">&quot;sources&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;openmaptiles&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;vector&quot;</span><span class="p">,</span>
        <span class="nt">&quot;tiles&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;http://localhost:3333/{z}/{x}/{y}.pbf&quot;</span>
        <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="nt">&quot;sprite&quot;</span><span class="p">:</span> <span class="s2">&quot;https://geoserveis.icgc.cat/contextmaps/sprites/sprite@1&quot;</span><span class="p">,</span>
  <span class="nt">&quot;glyphs&quot;</span><span class="p">:</span> <span class="s2">&quot;https://geoserveis.icgc.cat/contextmaps/glyphs/{fontstack}/{range}.pbf&quot;</span><span class="p">,</span>
  <span class="nt">&quot;layers&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;background&quot;</span><span class="p">,</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;background&quot;</span><span class="p">,</span>
      <span class="nt">&quot;paint&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;background-color&quot;</span><span class="p">:</span> <span class="s2">&quot;#f8f4f0&quot;</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;barrios&quot;</span><span class="p">,</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;fill&quot;</span><span class="p">,</span>
      <span class="nt">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;openmaptiles&quot;</span><span class="p">,</span>
      <span class="nt">&quot;source-layer&quot;</span><span class="p">:</span> <span class="s2">&quot;barrios&quot;</span><span class="p">,</span>
      <span class="nt">&quot;layout&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;visibility&quot;</span><span class="p">:</span> <span class="s2">&quot;visible&quot;</span>
      <span class="p">},</span>
      <span class="nt">&quot;paint&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;fill-color&quot;</span><span class="p">:</span> <span class="s2">&quot;#ff0000&quot;</span><span class="p">,</span>
        <span class="nt">&quot;fill-opacity&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;base&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
          <span class="nt">&quot;stops&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">[</span>
              <span class="mi">9</span><span class="p">,</span>
              <span class="mf">0.9</span>
            <span class="p">],</span>
            <span class="p">[</span>
              <span class="mi">22</span><span class="p">,</span>
              <span class="mf">0.3</span>
            <span class="p">]</span>
          <span class="p">]</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">],</span>
  <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;bcn-geodata&quot;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>Modificar el archivo static/index3.html para que cargue nuestro estilo</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&#39;utf-8&#39;</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Swipe between maps<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">&#39;viewport&#39;</span> <span class="na">content</span><span class="o">=</span><span class="s">&#39;initial-scale=1,maximum-scale=1,user-scalable=no&#39;</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&#39;https://api.tiles.mapbox.com/mapbox-gl-js/v0.49.0/mapbox-gl.js&#39;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">href</span><span class="o">=</span><span class="s">&#39;https://api.tiles.mapbox.com/mapbox-gl-js/v0.49.0/mapbox-gl.css&#39;</span> <span class="na">rel</span><span class="o">=</span><span class="s">&#39;stylesheet&#39;</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">style</span><span class="p">&gt;</span>
        <span class="nt">body</span> <span class="p">{</span> <span class="k">margin</span><span class="p">:</span><span class="mi">0</span><span class="p">;</span> <span class="k">padding</span><span class="p">:</span><span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
        <span class="p">#</span><span class="nn">map</span> <span class="p">{</span> <span class="k">position</span><span class="p">:</span><span class="kc">absolute</span><span class="p">;</span> <span class="k">top</span><span class="p">:</span><span class="mi">0</span><span class="p">;</span> <span class="k">bottom</span><span class="p">:</span><span class="mi">0</span><span class="p">;</span> <span class="k">width</span><span class="p">:</span><span class="mi">100</span><span class="kt">%</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">style</span><span class="p">&gt;</span>
<span class="nt">body</span> <span class="p">{</span>
    <span class="k">overflow</span><span class="p">:</span> <span class="kc">hidden</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">body</span> <span class="o">*</span> <span class="p">{</span>
   <span class="kp">-webkit-</span><span class="n">touch-callout</span><span class="p">:</span> <span class="kc">none</span><span class="p">;</span>
     <span class="kp">-webkit-</span><span class="k">user-select</span><span class="p">:</span> <span class="kc">none</span><span class="p">;</span>
        <span class="kp">-moz-</span><span class="k">user-select</span><span class="p">:</span> <span class="kc">none</span><span class="p">;</span>
         <span class="kp">-ms-</span><span class="k">user-select</span><span class="p">:</span> <span class="kc">none</span><span class="p">;</span>
             <span class="k">user-select</span><span class="p">:</span> <span class="kc">none</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">.</span><span class="nc">map</span> <span class="p">{</span>
    <span class="k">position</span><span class="p">:</span> <span class="kc">absolute</span><span class="p">;</span>
    <span class="k">top</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">bottom</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">width</span><span class="p">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#39;after&#39;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;map&#39;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>

<span class="kd">var</span> <span class="nx">afterMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mapboxgl</span><span class="p">.</span><span class="nx">Map</span><span class="p">({</span>
    <span class="nx">container</span><span class="o">:</span> <span class="s1">&#39;after&#39;</span><span class="p">,</span>
<span class="hll">    <span class="nx">style</span><span class="o">:</span> <span class="s1">&#39;bcn_geodata.json&#39;</span><span class="p">,</span>
</span>    <span class="nx">center</span><span class="o">:</span> <span class="p">[</span><span class="mf">2.16859</span><span class="p">,</span> <span class="mf">41.3954</span><span class="p">],</span>
    <span class="nx">zoom</span><span class="o">:</span> <span class="mi">13</span><span class="p">,</span>
    <span class="nx">maxZoom</span><span class="o">:</span> <span class="mi">16</span><span class="p">,</span>
    <span class="nx">hash</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nx">pitch</span><span class="o">:</span> <span class="mi">45</span>
<span class="p">});</span>

<span class="nx">afterMap</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">features</span> <span class="o">=</span> <span class="nx">afterMap</span><span class="p">.</span><span class="nx">queryRenderedFeatures</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">point</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">description</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">features</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">description</span><span class="p">);</span>
    <span class="cm">/*</span>
<span class="cm">    new mapboxgl.Popup()</span>
<span class="cm">            .setLngLat(e.lngLat)</span>
<span class="cm">            .setHTML(description)</span>
<span class="cm">            .addTo(afterMap);</span>
<span class="cm">            */</span>
<span class="p">});</span>

<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>

<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
</td></tr></table>

<h2 id="ejercicio">Ejercicio</h2>
<p>Agregar las capas de distritos y seccion_censal al estilo bcn_geodata</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../7_servidor_dinamico/" title="7. Cómo servir datos dinámicos" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Anterior
                </span>
                7. Cómo servir datos dinámicos
              </span>
            </div>
          </a>
        
        
          <a href="../9_geoserver_vts/" title="9. Servir vector tiles desde GeoServer" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Siguiente
                </span>
                9. Servir vector tiles desde GeoServer
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.583bbe55.js"></script>
      
        
        
          
          <script src="../assets/javascripts/lunr/lunr.stemmer.support.js"></script>
          
            
              
              
                <script src="../assets/javascripts/lunr/lunr.es.js"></script>
              
            
          
          
        
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
    
      
    
  </body>
</html>